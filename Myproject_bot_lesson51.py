#Telegram-–±–æ—Ç –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –∏ –≤—ã–¥–∞—á–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π
# –¶–µ–ª—å: –°–æ–∑–¥–∞—Ç—å —á–∞—Ç-–±–æ—Ç–∞ –¥–ª—è Telegram, –ø–æ–∑–≤–æ–ª—è—é—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º —Å–æ—Ö—Ä–∞–Ω—è—Ç—å —Ä–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞–Ω–Ω—ã–µ –∏–º —Ñ–∏–ª—å–º—ã,
# —Å–µ—Ä–∏–∞–ª—ã, –∫–Ω–∏–≥–∏, –ø—Ä–æ–¥—É–∫—Ç—ã –∏ –ø—Ä–æ—á–µ–µ) –∏ –≤ –ª—é–±–æ–π –º–æ–º–µ–Ω—Ç (–Ω–∞–ø—Ä–∏–º–µ—Ä, –∫–æ–≥–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞—Ö–æ—Ç–µ–ª –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å
# —Ñ–∏–ª—å–º) –ø–æ–ª—É—á–∞—Ç—å –æ–¥–Ω—É –∏–ª–∏ —Å–ø–∏—Å–æ–∫ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π –ø–æ –Ω—É–∂–Ω–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏.
# –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª:
# - –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ –∫–æ–º–∞–Ω–¥–µ /start —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—è—Ö –±–æ—Ç–∞ –∏ –º–µ–Ω—é.
# - –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤—ã—Ö —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º (—Ñ–∏–ª—å–º—ã, —Å–µ—Ä–∏–∞–ª—ã, –∫–Ω–∏–≥–∏, –¥—Ä—É–≥–æ–µ):
# - /add - –∫–æ–º–∞–Ω–¥–∞ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏.
# - –î–∞–ª–µ–µ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç—Å—è –≤—ã–±–æ—Ä –∫–∞—Ç–µ–≥–æ—Ä–∏–∏: —Ñ–∏–ª—å–º—ã, –∫–Ω–∏–≥–∏, —Å–µ—Ä–∏–∞–ª–∞, –¥—Ä—É–≥–æ–µ.
# - –ü–æ—Å–ª–µ –≤—ã–±–æ—Ä–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –±–æ—Ç –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ –ø—Ä–æ—Å–∏—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤–≤–µ—Å—Ç–∏ –Ω–∞–∑–≤–∞–Ω–∏–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, ‚Äú–¢–∏—Ç–∞–Ω–∏–∫‚Äù/ ‚Äú–ë–µ–≥—É—â–∞—è —Å –í–æ–ª–∫–∞–º–∏‚Äù) –∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –∫ —ç—Ç–æ–π —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ - —ç—Ç–æ –º–æ–∂–µ—Ç –±—ã—Ç—å –ª—é–±–æ–π —Å–æ–ø—Ä–æ–≤–æ–¥–∏—Ç–µ–ª—å–Ω—ã–π —Ç–µ–∫—Å—Ç: ‚Äù–ø–æ—Å–æ–≤–µ—Ç–æ–≤–∞–ª–∞ –ú–∞—à–∞/ –∏–∑ –±–ª–æ–≥–∞ –í–∞—Å–∏/ —Å–º–æ—Ç—Ä–µ—Ç—å, –µ—Å–ª–∏ –≥—Ä—É—Å—Ç–Ω–æ/ –∞–≤—Ç–æ—Ä - –†–∏—á–∞—Ä–¥ –ë–∞—Ö/ –ø—Ä–æ –º–æ—Ç–∏–≤–∞—Ü–∏—é –∏ —Ç.–ø‚Äù.
# - –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö —Å–æ —Å—Ç–æ–ª–±—Ü–∞–º–∏ (id –∑–∞–ø–∏—Å–∏, id –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –∫–∞—Ç–µ–≥–æ—Ä–∏—è, –Ω–∞–∑–≤–∞–Ω–∏–µ, –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π).
# - –ü–æ–∏—Å–∫ –∏ –ø—Ä–æ—Å–º–æ—Ç—Ä —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π:
# - /find - –∫–æ–º–∞–Ω–¥–∞ –¥–ª—è –Ω–∞—á–∞–ª–∞ –ø–æ–∏—Å–∫–∞. –ü–æ–∏—Å–∫ –≤–µ–¥–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø–æ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è–º, –∫–æ—Ç–æ—Ä—ã–µ –¥–æ–±–∞–≤–ª–µ–Ω—ã —ç—Ç–∏–º –∂–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º (–ø–æ id –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è).
# - –î–∞–ª–µ–µ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç—Å—è –≤—ã–±–æ—Ä –∫–∞—Ç–µ–≥–æ—Ä–∏–∏: —Ñ–∏–ª—å–º—ã, –∫–Ω–∏–≥–∏, —Å–µ—Ä–∏–∞–ª–∞, –¥—Ä—É–≥–æ–µ.
# - –î–∞–ª–µ–µ –≤—ã–±–æ—Ä –∏–∑ 2-—Ö –æ–ø—Ü–∏–π:
# 1. /anything - –ó–∞–ø—Ä–æ—Å –Ω–∞ –≤—ã–¥–∞—á—É —Ä–∞–Ω–¥–æ–º–Ω–æ–π —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –≤ –≤—ã–±—Ä–∞–Ω–Ω–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏. –§–æ—Ä–º–∞—Ç –≤—ã–¥–∞—á–∏: –Ω–∞–∑–≤–∞–Ω–∏–µ –∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π.
# 2. /specific - –ë–æ—Ç –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤–≤–µ—Å—Ç–∏ –∫–ª—é—á–µ–≤–æ–µ —Å–ª–æ–≤–æ, –ø–æ–∏—Å–∫ –≤–µ–¥–µ—Ç—Å—è –ø–æ –¥–≤—É–º —Å—Ç–æ–ª–±—Ü–∞–º: –Ω–∞–∑–≤–∞–Ω–∏–µ –∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π.
# - –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è–º–∏:
# - –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∏ —É–¥–∞–ª—è—Ç—å —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏. (–∫–æ–º–∞–Ω–¥—ã –≤ –º–µ–Ω—é: /edit - —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å, /del - —É–¥–∞–ª–∏—Ç—å.)

#–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –ø–æ pandas	https://pandas.pydata.org/docs/user_guide/index.html

# –ò–º–ø–æ—Ä—Ç –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö –±–∏–±–ª–∏–æ—Ç–µ–∫
from array import ArrayType
import requests  # –î–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è HTTP-–∑–∞–ø—Ä–æ—Å–æ–≤ –∫ API
import logging  # –î–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–∏—Å—Ç–µ–º—ã –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
import csv  # –î–ª—è —Ä–∞–±–æ—Ç—ã —Å CSV-—Ñ–∞–π–ª–∞–º–∏ (—á—Ç–µ–Ω–∏–µ/–∑–∞–ø–∏—Å—å)
from datetime import datetime  # –î–ª—è —Ä–∞–±–æ—Ç—ã —Å –¥–∞—Ç–æ–π –∏ –≤—Ä–µ–º–µ–Ω–µ–º
import pandas as pd  # –î–ª—è –∞–Ω–∞–ª–∏–∑–∞ –∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –¥–∞–Ω–Ω—ã—Ö
import matplotlib.pyplot as plt  # –î–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –≥—Ä–∞—Ñ–∏–∫–æ–≤ –∏ –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏ –¥–∞–Ω–Ω—ã—Ö
from io import BytesIO  # –î–ª—è —Ä–∞–±–æ—Ç—ã —Å –±–∏–Ω–∞—Ä–Ω—ã–º–∏ –ø–æ—Ç–æ–∫–∞–º–∏ –≤ –ø–∞–º—è—Ç–∏
import os  # –î–ª—è –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è —Å —Ñ–∞–π–ª–æ–≤–æ–π —Å–∏—Å—Ç–µ–º–æ–π
import time #–¥–ª—è –∑–∞–º–µ—Ä–∞ –≤—Ä–µ–º–µ–Ω–∏
from dotenv import load_dotenv #config.env
from fontTools.misc.bezierTools import namedtuple

# –ò–º–ø–æ—Ä—Ç –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ Telegram API
from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup, ReplyKeyboardMarkup, KeyboardButton, \
    ReplyKeyboardRemove
from telegram.ext import Updater, CommandHandler, CallbackQueryHandler, CallbackContext, MessageHandler, Filters, \
    ConversationHandler

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Å–∏—Å—Ç–µ–º—ã –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
logging.basicConfig(
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',  # –§–æ—Ä–º–∞—Ç –∑–∞–ø–∏—Å–∏ –ª–æ–≥–æ–≤
    level=logging.INFO  # –£—Ä–æ–≤–µ–Ω—å –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏–∏ –ª–æ–≥–æ–≤
)
logger = logging.getLogger(__name__)  # –°–æ–∑–¥–∞–Ω–∏–µ –ª–æ–≥–≥–µ—Ä–∞ –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ –º–æ–¥—É–ª—è

load_dotenv("config.env")

# –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã –¥–ª—è —Ä–∞–±–æ—Ç—ã –±–æ—Ç–∞
TOKEN = os.getenv("TELEGRAM_BOT_TOKEN")
#OPENWEATHER_API_KEY = os.getenv("OPENWEATHER_API_KEY")  # API-–∫–ª—é—á OpenWeatherMap
#my_telegram_id = os.getenv("MY_TELEGRAM_ID")
#CBR_API_URL = "https://www.cbr-xml-daily.ru/daily_json.js"  # URL API –¶–µ–Ω—Ç—Ä–æ–±–∞–Ω–∫–∞ –¥–ª—è –∫—É—Ä—Å–æ–≤ –≤–∞–ª—é—Ç
COMMENT_LOG_PATH = "comments_log.csv"  # –ü—É—Ç—å –∫ —Ñ–∞–π–ª—É –ª–æ–≥–æ–≤ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π
ADMIN_IDS = [my_telegram_id]  # –°–ø–∏—Å–æ–∫ ID –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤ –±–æ—Ç–∞
#print(f"—Ç–æ–∫–µ–Ω={TOKEN} OPENWEATHER_API_KEY = {OPENWEATHER_API_KEY} my_telegram_id ={my_telegram_id}")

# –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏–π –¥–ª—è ConversationHandler
WAIT_CATEGORY, WAIT_KEYWORD, SHOW_INFO = range(3)  # –°–æ—Å—Ç–æ—è–Ω–∏—è: –æ–∂–∏–¥–∞–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏, –∫–ª—é—á–µ–≤–æ–π —Ñ—Ä–∞–∑—ã –∏ –ø–æ–∫–∞–∑ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏

current_category_id = 0
DB_path = "comments.db"
conn = sqlite3.connect("comments.db")
cursor = conn.cursor()

class Users():
    def __init__(self):
        cursor.execute('''CREATE TABLE IF NOT EXISTS users (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            name TEXT NOT NULL,
            dt_first DATATIME NOT NULL,     # –¥–∞—Ç–∞ –∏ –≤—Ä–µ–º—è –∫–æ–≥–¥–∞ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–ª—Å—è
            comment TEXT,   # –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –æ —Å–µ–±–µ 
            #–î–ª—è –ø–æ–∏—Å–∫–∞ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π:
            max_comments int, # –º–∞–∫—Å. –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π –ø—Ä–∏ –ø–æ–∏—Å–∫–µ (0 - –≤—Å–µ)
            category_id int, # id –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –ø—Ä–∏ –ø–æ–∏—Å–∫–µ (0 - –≤—Å–µ)
            result TEXT, #last - –ø–æ—Å–ª–µ–¥–Ω–∏–µ, first - –ø–µ—Ä–≤—ã–µ, random - —Ä–∞–Ω–¥–æ–º–Ω—ã–µ
            keyword TEXT #–∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞
    )
        ''')
        self.stru_find = {'user_id':0,'category_id':0,'random':False, keyword:str}

    def is_exist_user(self, user_id:int) -> bool:
        try:
            cursor.execute("SELECT * FROM users WHERE id = ?", (user_id,))
            row = cursor.fetchone()
            if row:
                return True
            else:
                return False
        except e:
            print(f"–û—â–∏–±–∫–∞ –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö {e}")
            return False

    def get_user_id(self, name:str) -> int:
        try:
            cursor.execute("SELECT * FROM users WHERE name = ?", (name,))
            row = cursor.fetchone()
            if row:
                return row.id
            else:
                return 0

        except e:
            print(f"–û—â–∏–±–∫–∞ –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö {e}")
            return 0

    def get_user_find_parametrs(self, user_id:int):
        try:
            cursor.execute("SELECT * FROM users WHERE id = ?", (user_id,))
            row = cursor.fetchone()
            if row:
                return {'max_comments':max_comments,'category_id':category_id,'result':result,'keyword':keyword}
            else:
                return {}

        except e:
            print(f"–û—â–∏–±–∫–∞ –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö {e}")
            return  {}

    def change_find_parametr(self, user_id:int, param:str, value:str) -> str:
        if param in ("max_comments","category_id"):
            try:
                m = int( value )
            except:
                txt = "–í–≤–µ–¥–∏—Ç–µ —á–∏—Å–ª–æ, –∞ –Ω–µ —Å—Ç—Ä–æ–∫—É!"
                return txt
        elif param == "result":
            val = value.strip().lower()
            if not (val in ('last','first''random')):
                txt = "–í–≤–µ–¥–∏—Ç–µ last –∏–ª–∏ first –∏–ª–∏ random"
                return txt

        try:
            txt = "–£—Å–ø–µ—Ö!"
            if param == "max_comments":
                cursor.execute("UPDATE Users SET max_comments = ? WHERE id = ?", (m, user_id,))
                conn.commit()
            elif param == "category_id":
                cursor.execute("UPDATE Users SET category_id = ? WHERE id = ?", (m, user_id,))
                conn.commit()
            elif param == "result":
                cursor.execute("UPDATE Users SET result = ? WHERE id = ?", (value.strip().lower(), user_id,))
                conn.commit()
            elif param == "keyword":
                cursor.execute("UPDATE Users SET keyword = ? WHERE id = ?", (value, user_id,))
                conn.commit()
            else:
                txt = f"{param} —É–∫–∞–∑–∞–Ω –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ. –ù—É–∂–Ω–æ —É–∫–∞–∑–∞—Ç—å max_comments –∏–ª–∏ category_id –∏–ª–∏ result –∏–ª–∏ keyword"

        except e:
            txt = f"–ü—Ä–æ–±–ª–µ–º–∞ —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö {e}"

        return txt

    def append_user(self, name:str, comment:str='') -> int:
        try:
            id = self.get_user_id(name)

            if id != 0:
                return id
            else:
                cursor.execute("INSERT INTO users (name, comment, dt_first, max_comments, category_id, result, keyword ) "
                               "VALUES (?, ?, ?, ?, ?, ?, ?)",
                               (name, comment, datetime.now().isoformat(), 0, 0, 'random',''))
                conn.commit()
                id = cursor.lastrowid
                return id

        except e:
            print(f"–û—â–∏–±–∫–∞ –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö {e}")
            return 0

class Categories():
    def __init__(self):
        cursor.execute('''CREATE TABLE IF NOT EXISTS categories (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            name TEXT NOT NULL,
            active BOOLEAN, 
            parent_id INTEGER 
        )
        ''')
        conn.commit()

    def is_exist_category(self, category_id:int) -> bool:
        try:
            cursor.execute("SELECT * FROM categories WHERE active=True and id = ?", (category_id,))
            row = cursor.fetchone()
            if row:
                return True
            else:
                return False
        except e:
            print(f"–û—â–∏–±–∫–∞ –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö {e}")
            return False

    def add_category(self, name:str, parent_id:int) -> int:
        #–û–±–µ—Å–ø–µ—á–∏–≤–∞–µ–º –∏–µ—Ä–∞—Ä—Ö–∏—é –∫–∞—Ç–µ–≥–æ—Ä–∏–π
        try:
            if parent_id == 0:
                cursor.execute("INSERT INTO categories (name, active, parent_id) VALUES (?, ?, ?)",
                               (name, True, parent_id))
            elif self.is_exist_category( parent_id ):
                cursor.execute("INSERT INTO categories (name, active, parent_id) VALUES (?, ?, ?)",
                                   (name, True, parent_id))

            else:
                cursor.execute("INSERT INTO categories (name, active, parent_id) VALUES (?, ?, ?)",
                                   (name, True, 0))
                print(f"–£–∫–∞–∑–∞–Ω –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π id = {parent_id} —Ä–æ–¥–∏—Ç–µ–ª—è –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ {name}. –£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –±–µ–∑ –∏–µ—Ä–∞—Ä—Ö–∏–∏")

            id = cursor.lastrowid

            conn.commit()
        except e:
            print(f"–û—â–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ {name} –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö {e}")
            id = 0

        return id

    def change_parent_for_category(self, category_id: int, parent_id: int):
        # –û–±–µ—Å–ø–µ—á–∏–≤–∞–µ–º –∏–µ—Ä–∞—Ä—Ö–∏—é –∫–∞—Ç–µ–≥–æ—Ä–∏–π
        try:
            cursor.execute("SELECT * FROM categories WHERE id = ?", (parent_id,))
            row = cursor.fetchone()
            if not row:
                print(f"–£–∫–∞–∑–∞–Ω –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π id = {parent_id} —Ä–æ–¥–∏—Ç–µ–ª—è –ø—Ä–∏ –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è –∏–µ—Ä–∞—Ä—Ö–∏–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ —Å id={category_id}")
            else:
                cursor.execute("SELECT * FROM categories WHERE id = ?", (category_id,))
                row = cursor.fetchone()
                if not row:
                    print(f"–£–∫–∞–∑–∞–Ω –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π id = {category_id} –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è")
                else:
                    cursor.execute("UPDATE categories SET parent_id= ? WHERE id = ?", (parent_id,category_id,))
                    print("–£—Å–ø–µ—Ö!")
            conn.commit()
        except e:
            print(f"–û—â–∏–±–∫–∞ –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö {e}")

    def change_name_for_category(self, category_id: int, name: str):
        # –û–±–µ—Å–ø–µ—á–∏–≤–∞–µ–º –∏–µ—Ä–∞—Ä—Ö–∏—é –∫–∞—Ç–µ–≥–æ—Ä–∏–π
        try:
            cursor.execute("SELECT * FROM categories WHERE id = ?", (category_id,))
            row = cursor.fetchone()
            if not row:
                print(f"–£–∫–∞–∑–∞–Ω –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π id = {category_id} –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è")
            else:
                cursor.execute("UPDATE categories SET name= ? WHERE id = ?", (name,category_id,))
                print("–£—Å–ø–µ—Ö!")
                conn.commit()
        except e:
            print(f"–û—â–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ {name} –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö {e}")

    def change_active_category(self, category_id:int) :
        cursor.execute("SELECT active FROM categories WHERE id = ?", (category_id,))
        row = cursor.fetchone()
        if row:
            if row.active:
                cursor.execute("UPDATE categories SET active=False WHERE id = ?", (category_id,))
            else:
                cursor.execute("UPDATE categories SET active=True WHERE id = ?", (category_id,))

            conn.commit()
        else:
            print(f"–î–ª—è –≤—ã–±–æ—Ä–∞ –∫–∞—Ç–µ–≥—Ä–∏–∏ —É–∫–∞–∑–∞–Ω –Ω–µ–∫–æ—Ä—Ä–∫—Ç–Ω—ã–π id {category_id,}")

    def list_categories(self, parent_id:int) -> ArrayType:
        cursor.execute("SELECT * FROM categories WHERE active=True and parent_id = ? ORDER BY name ASC", (parent_id,))
        rows = cursor.fetchall()

        arr = []
        for row in rows:
            arr.append({'id':row.id,'name':row.name})

        return arr

    # –≤—ã–±–∏—Ä–∞—é—Ç—Å—è –∫–∞—Ç–µ–≥–æ—Ä–∏–∏, –Ω–∞—á–∏–Ω–∞—è —Å –∑–∞–¥–∞–Ω–Ω–æ–π –∏ –Ω–∏–∂–µ –ø–æ –∏–µ—Ä–∞—Ä—Ö–∏–∏
    def tree_categories(self, category_id:int) -> ArrayType:

        arr = []
        id = category_id
        arr.append(id)
        arr1 = arr

        flag = True
        while flag:
            cursor.execute("SELECT * FROM categories WHERE active=True and parent_id IN ?", (arr1,))
            rows = cursor.fetchall()
            arr1 = []
            for row in rows:
                arr.append(row.id)
                arr1.append(row.id)

            flag = (arr1.count() == 0)

        return arr

class Comments():
    def __init__(self):
        cursor.execute('''CREATE TABLE IF NOT EXISTS comments (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            user_id INTEGER 
            category_id INTEGER 
            name TEXT NOT NULL,
            comment TEXT NOT NULL, 
            dt DATATIME NOT NULL,     # –¥–∞—Ç–∞ –∏ –≤—Ä–µ–º—è –∫–æ–≥–¥–∞ –∏–∑–º–µ–Ω–∏–ª –∑–∞–ø–∏—Å—å
        )
        ''')
        conn.commit()

        self.users = Users()
        self.categories = Categories()

    def add_comment(self,user_id:int,category_id:int,name:str,comment:str):
        cursor.execute("INSERT INTO comments (user_id,category_id,name,comment,dt) VALUES (?, ?, ?, ?, ?)",
                       (user_id, category_id, name, comment, datetime.now().isoformat(), ))
        conn.commit()

    def find_comments(self,user_id:int,from_user_id:int=0) -> str:

        if from_user_id > 0 and self.users.is_exist_user(from_user_id):
            # –°–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—É—é —Ç–∞–±–ª–∏—Ü—É –¥–ª—è –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
            cursor.execute("""
                DROP TABLE IF EXISTS temp_params_from_user;
                CREATE TEMP TABLE temp_params_from_user (from_user_id INTEGER)
                """)
            cursor.execute("INSERT INTO temp_params_from_user (from_user_id) VALUES (?)", (from_user_id,))

            # –ò—Å–ø–æ–ª—å–∑—É–µ–º –≤—Ä–µ–º–µ–Ω–Ω—É—é —Ç–∞–±–ª–∏—Ü—É –≤ –∑–∞–ø—Ä–æ—Å–µ
            cursor.execute("""
            CREATE VIEW IF NOT EXISTS from_comments AS
            SELECT c.* FROM comments c, temp_params_from_user p WHERE c.user_id = p.from_user_id
            """)
        else:
            cursor.execute("""
             CREATE VIEW IF NOT EXISTS from_comments AS
             SELECT c.* FROM comments c
             """)

        # –ø–æ–ª—É—á–∞–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–æ–∏—Å–∫–∞ result –∏ max_comments –ø–æ—Ç–æ–º - category_id,keyword
        params = self.users.get_user_find_parametrs(user_id)
        max_comments = params.get('max_comments', 0)
        result = params.get('result', 'random')

        if max_comments > 0 and (result == 'first' or result == 'last'):
            # –°–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—É—é —Ç–∞–±–ª–∏—Ü—É –¥–ª—è –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
            cursor.execute("""
                DROP TABLE IF EXISTS temp_params_max_comments;
                CREATE TEMP TABLE temp_params_max_comments (max_comments INTEGER)
            """)

            cursor.execute("INSERT INTO temp_params_max_comments (max_comments) VALUES (?)", (max_comments,))

            # –ò—Å–ø–æ–ª—å–∑—É–µ–º –≤—Ä–µ–º–µ–Ω–Ω—É—é —Ç–∞–±–ª–∏—Ü—É –≤ –∑–∞–ø—Ä–æ—Å–µ
            if result == 'first':
              cursor.execute("""
              CREATE VIEW IF NOT EXISTS max_comments AS
              SELECT c.* FROM from_comments c, temp_params_max_comments p ORDER BY dt ASC LIMIT p.max_comments
              """)
            else:
                cursor.execute("""
                 CREATE VIEW IF NOT EXISTS max_comments AS
                 SELECT c.* FROM from_comments c, temp_params_max_comments p ORDER BY dt DSC LIMIT p.max_comments
                 """)

        else:
            cursor.execute("""
               CREATE VIEW IF NOT EXISTS max_comments AS
               SELECT c.* FROM from_comments c
               """)

        #–ø–æ–ª—É—á–∞–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–æ–∏—Å–∫–∞ category_id
        category_id = params.get('category_id',0)

        if category_id > 0 :
            #–ü–æ–ª—É—á–∞–µ–º –º–∞—Å—Å–∏–≤ —Å –ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏—è–º–∏
            arr_category_id = self.categories.tree_categories(category_id)

            # –°–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—É—é —Ç–∞–±–ª–∏—Ü—É –¥–ª—è –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
            cursor.execute("""
                 DROP TABLE IF EXISTS temp_params_category_id;
                 CREATE TEMP TABLE temp_params_category_id (category_id INTEGER)
             """)
            for cat_id in arr_category_id:
                cursor.execute("INSERT INTO temp_params_category_id (category_id) VALUES (?)", (cat_id,))

            # –ò—Å–ø–æ–ª—å–∑—É–µ–º –≤—Ä–µ–º–µ–Ω–Ω—É—é —Ç–∞–±–ª–∏—Ü—É –≤ –∑–∞–ø—Ä–æ—Å–µ
            cursor.execute("""
             CREATE VIEW IF NOT EXISTS category_id AS
             SELECT c.* FROM max_comments c
             INNER JOIN temp_params_category_id p ON c.category_id = p.category_id
             """)
        else:
            cursor.execute("""
              CREATE VIEW IF NOT EXISTS category_id AS
              SELECT c.* FROM max_comments c
              """)

        # –ø–æ–ª—É—á–∞–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–æ–∏—Å–∫–∞ keyword
        keyword = params.get('keyword', '')
        arr_keyword = []
        arr_keyword1 = keyword.split()
        for kword1 in arr_keyword1:
            arr_keyword2 = kword1.split(';')
            for kword2 in arr_keyword2:
                arr_keyword3 = kword2.split(',')
               for kword3 in arr_keyword3:
                   if kword3.count()>0:
                        arr_keyword.append(kword3)

       if len(arr_keyword) > 0:
            len_arr = len(arr_keyword)
            # –°–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—É—é —Ç–∞–±–ª–∏—Ü—É –¥–ª—è –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
            cursor.execute("""
                  DROP TABLE IF EXISTS temp_params_keyword;
                  CREATE TEMP TABLE temp_params_keyword (keyword TEXT, len_arr INT)
              """)
            for kword in arr_keyword:
                cursor.execute("INSERT INTO temp_params_category_id (keyword,len_arr) VALUES (?,?)", (kword,len_arr))

            # –ò—Å–ø–æ–ª—å–∑—É–µ–º –≤—Ä–µ–º–µ–Ω–Ω—É—é —Ç–∞–±–ª–∏—Ü—É –≤ –∑–∞–ø—Ä–æ—Å–µ: –≤–Ω–∞—á–∞–ª–µ —Å–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—É—é —Ç–∞–±–ª–∏—Ü—É —Å id —Ç–µ—Ö —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π,
            # –≤ –∫–æ—Ç–æ—Ä—ã—Ö –µ—Å—Ç—å –≤—Å–µ —Å–ª–æ–≤–∞ –±–µ–∑ —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª–µ–π ';',',',' '
            cursor.execute("""
               CREATE VIEW IF NOT EXISTS comments_id_kword AS
               SELECT c.id AS id, COUNT(p.keyword) AS cnt, MAX(p.len_arr) AS len_arr FROM category_id c
               INNER JOIN temp_params_keyword p ON (c.name LIKE '%' || p.keyword || '%') 
                                                OR (c.comment LIKE '%' || p.keyword || '%')
               GROUP BY
                    c.id 
               HAVING 
                    HAVING COUNT(p.keyword) = MAX(p.len_arr)
               """)
            cursor.execute("""
                CREATE VIEW IF NOT EXISTS comments_kword AS
                SELECT c.* FROM category_id c
                INNER JOIN comments_id_kword c_id ON (c.id = c_id.id)
                 """)

       else:
            cursor.execute("""
                CREATE VIEW IF NOT EXISTS comments_kword AS
                SELECT c.* FROM category_id c
                """)

       cursor.execute("""
           SELECT c.name AS name, c.comment AS comment, c.dt AS dat, usr.name AS user, usr.comment AS about_user, cat.name AS category FROM comments_kword c
                 INNER JOIN user usr ON (c.user_id = usr.id)
                 INNER JOIN categories cat ON (c.category_id = cat.id)
            """)

        rows = cursor.fetchall()

        if max_comments > 0:
            if max_comments > len(rows):
                max_comments = len(rows)
        else:
            max_comments = len(rows)

        i = 0
        arr_int = []
        while i < max_comments:
            arr_int.append(i)
            i = i + 1

        #–û—Å—Ç–∞–ª–æ—Å—å —É—á–µ—Å—Ç—å —Å–ª—É—á–∞–π –∫–æ–≥–¥–∞ result='random'
        if result == 'random':
          random.shuffle(arr_int)

       txt = ""
       for i in range(len(arr_int)):
           txt = txt + rows[arr_int[i]] + "\n"

       return txt

 #–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ñ–∞–π–ª–∞ –ª–æ–≥–æ–≤
if not os.path.exists(COMMENT_LOG_PATH):
    # –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ —Ñ–∞–π–ª–∞ —Å –∑–∞–≥–æ–ª–æ–≤–∫–∞–º–∏
    with open(COMMENT_LOG_PATH, 'w', newline='', encoding='utf-8') as file:
        writer = csv.writer(file)
        writer.writerow(['timestamp', 'user_id', 'username', 'category_id', 'keyword', 'status'])
else:
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ —Ñ–∞–π–ª–∞ –Ω–∞ –Ω–∞–ª–∏—á–∏–µ –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤
    with open(COMMENT_LOG_PATH, 'r', encoding='utf-8') as f:
        first_line = f.readline().strip()
        # –ï—Å–ª–∏ –∑–∞–≥–æ–ª–æ–≤–∫–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç - –¥–æ–±–∞–≤–ª—è–µ–º –∏—Ö
        if not first_line.startswith('timestamp') or 'user_id' not in first_line:
            with open(WEATHER_LOG_PATH, 'r+', encoding='utf-8') as f:
                content = f.read()
                f.seek(0, 0)
                f.write('timestamp,user_id,username,category_id,keyword,status\n' + content)


def log_comment_request(user_id: int, username: str, category_id: int, keyword: str, status: str):
    """–ó–∞–ø–∏—Å—ã–≤–∞–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∑–∞–ø—Ä–æ—Å–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π –≤ CSV-–ª–æ–≥"""
    try:
        # –û—Ç–∫—Ä—ã—Ç–∏–µ —Ñ–∞–π–ª–∞ –≤ —Ä–µ–∂–∏–º–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è
        with open(COMMENT_LOG_PATH, 'a', newline='', encoding='utf-8') as file:
            writer = csv.writer(file)
            # –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Ç—Ä–æ–∫–∏ –ª–æ–≥–∞
            writer.writerow([
                datetime.now().isoformat(),  # –¢–µ–∫—É—â–∞—è –¥–∞—Ç–∞ –∏ –≤—Ä–µ–º—è
                user_id,  # ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                username,  # –ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                category_id,  # –ó–∞–ø—Ä–æ—à–µ–Ω–Ω–∞—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è
                keyword,  # –ó–∞–ø—Ä–æ—à–µ–Ω–Ω–æ–µ —Å–ª–æ–≤–æ/—Ñ—Ä–∞–∑–∞
                status  # –°—Ç–∞—Ç—É—Å –∑–∞–ø—Ä–æ—Å–∞: success/not_found
            ])
    except Exception as e:
        # –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –∑–∞–ø–∏—Å–∏ –≤ –ª–æ–≥
        logger.error(f"–û—à–∏–±–∫–∞ –∑–∞–ø–∏—Å–∏ –≤ –ª–æ–≥: {e}")


# def create_reply_keyboard():
#     """–°–æ–∑–¥–∞–µ—Ç –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É —Å –æ—Å–Ω–æ–≤–Ω—ã–º–∏ –∫–æ–º–∞–Ω–¥–∞–º–∏"""
#     return ReplyKeyboardMarkup(
#         [
#             ["üå§Ô∏è –£–∑–Ω–∞—Ç—å –ø–æ–≥–æ–¥—É", "–ö–∞—Ç–∞–ª–æ–≥"],  # –ü–µ—Ä–≤—ã–π —Ä—è–¥ –∫–Ω–æ–ø–æ–∫
#             ['üìû –ö–æ–Ω—Ç–∞–∫—Ç—ã', "–ú–æ–π –ø—Ä–æ—Ñ–∏–ª—å"],  # –í—Ç–æ—Ä–æ–π —Ä—è–¥
#             # –°–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ –∫–Ω–æ–ø–∫–∏ —Å –∑–∞–ø—Ä–æ—Å–æ–º –¥–∞–Ω–Ω—ã—Ö
#             [KeyboardButton("–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∫–æ–Ω—Ç–∞–∫—Ç", request_contact=True),
#              KeyboardButton("–û—Ç–ø—Ä–∞–≤–∏—Ç—å –≥–µ–æ–ª–æ–∫–∞—Ü–∏—é", request_location=True)]
#         ],
#         resize_keyboard=True,  # –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ —Ä–∞–∑–º–µ—Ä–∞
#         input_field_placeholder="–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ"  # –ü–æ–¥—Å–∫–∞–∑–∫–∞ –≤ –ø–æ–ª–µ –≤–≤–æ–¥–∞
#     )


def create_profile_keyboard():
    """–°–æ–∑–¥–∞–µ—Ç –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É –¥–ª—è —Ä–∞–∑–¥–µ–ª–∞ –ø—Ä–æ—Ñ–∏–ª—è"""
    return ReplyKeyboardMarkup(
        [["‚úè–ò–∑–º–µ–Ω–∏—Ç—å –∏–º—è", "–î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è"], ["–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é"]],
        resize_keyboard=True,  # –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ —Ä–∞–∑–º–µ—Ä–∞
        one_time_keyboard=True  # –°–∫—Ä—ã—Ç–∏–µ –ø–æ—Å–ª–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
    )


def create_main_menu_keyboard():
    """–°–æ–∑–¥–∞–µ—Ç –∏–Ω–ª–∞–π–Ω-–∫–ª–∞–≤–∏–∞—Ç—É—Ä—É –≥–ª–∞–≤–Ω–æ–≥–æ –º–µ–Ω—é"""
    f"/categories ‚Äì –ê–∫—Ç—É–∞–ª—å–Ω—ã–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏\n"
    f"/category ‚Äì –†–∞–±–æ—Ç–∞ —Å –∫–∞—Ç–µ–≥–æ—Ä–∏–µ–π\n"
    f"/add ‚Äì –î–æ–±–∞–≤–∏—Ç—å —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—é –≤ –∫–∞—Ç–µ–≥–æ—Ä–∏—é\n"
    f"/find ‚Äì –ù–∞–π—Ç–∏ —Å–≤–æ—é —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—é (–¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è, —É–¥–∞–ª–µ–Ω–∏—è)\n"
    f"/anything ‚Äì –ò—Å–∫–∞—Ç—å —Å–ª—É—á–∞–π–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏\n"
    f"/specific ‚Äì –ò—Å–∫–∞—Ç—å —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ —Å–ª–æ–≤—É/—Ñ—Ä–∞–∑–µ"

    keyboard = [
        [
            # –ö–Ω–æ–ø–∫–∏ –ø–µ—Ä–≤–æ–≥–æ —Ä—è–¥–∞
            InlineKeyboardButton("üå§Ô∏è –ê–∫—Ç—É–∞–ª—å–Ω—ã–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏", callback_data='categories'),
            InlineKeyboardButton("üñ•Ô∏è –†–∞–±–æ—Ç–∞ —Å –∫–∞—Ç–µ–≥–æ—Ä–∏–µ–π", callback_data='category'),
        ],
        [
            # –ö–Ω–æ–ø–∫–∏ –≤—Ç–æ—Ä–æ–≥–æ —Ä—è–¥–∞
            InlineKeyboardButton("üå§Ô∏è –î–æ–±–∞–≤–∏—Ç—å —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—é", callback_data='add_comment'),
            InlineKeyboardButton("üñ•Ô∏è –ù–∞–π—Ç–∏ —Å–≤–æ—é —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—é", callback_data='find_comment'),
        ],
        [
            # –ö–Ω–æ–ø–∫–∏ —Ç—Ä–µ—Ç—å–µ–≥–æ —Ä—è–¥–∞
            InlineKeyboardButton("üå§Ô∏è –ò—Å–∫–∞—Ç—å —Å–ª—É—á–∞–π–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏", callback_data='anything'),
            InlineKeyboardButton("üñ•Ô∏è –ò—Å–∫–∞—Ç—å —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ —Å–ª–æ–≤—É/—Ñ—Ä–∞–∑–µ", callback_data='specific'),
        ],
        [InlineKeyboardButton("‚ùå –ó–∞–∫—Ä—ã—Ç—å", callback_data='close')]  # –ö–Ω–æ–ø–∫–∞ –∑–∞–∫—Ä—ã—Ç–∏—è
    ]
    return InlineKeyboardMarkup(keyboard)  # –í–æ–∑–≤—Ä–∞—Ç —Ä–∞–∑–º–µ—Ç–∫–∏ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã

#   –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–æ–º–∞–Ω–¥
def start(update: Update, context: CallbackContext) -> None:
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /start"""
    user = update.effective_user  # –ü–æ–ª—É—á–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ
    command_text = (
                    f"/categories ‚Äì –ê–∫—Ç—É–∞–ª—å–Ω—ã–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏\n"
                    f"/category ‚Äì –†–∞–±–æ—Ç–∞ —Å –∫–∞—Ç–µ–≥–æ—Ä–∏–µ–π\n"
                    f"/add ‚Äì –î–æ–±–∞–≤–∏—Ç—å —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—é –≤ –∫–∞—Ç–µ–≥–æ—Ä–∏—é\n"
                    f"/find ‚Äì –ù–∞–π—Ç–∏ —Å–≤–æ—é —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—é\n"
                    f"/anything ‚Äì –ò—Å–∫–∞—Ç—å —Å–ª—É—á–∞–π–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏\n"
                    f"/ specific ‚Äì –ò—Å–∫–∞—Ç—å —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ —Å–ª–æ–≤—É/—Ñ—Ä–∞–∑–µ"
    )

    # # –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –æ—Å–Ω–æ–≤–Ω–æ–π –∫–ª–∞–≤–∏–∞—Ç—É—Ä–æ–π
    update.message.reply_text(
        f"–ü—Ä–∏–≤–µ—Ç, {user.first_name}! –Ø —Ç–≤–æ–π –±–æ—Ç –ø–æ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è–º."
        f"–¢—ã –º–æ–∂–µ—à—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∫–Ω–æ–ø–∫–∏ –Ω–∏–∂–µ –∏–ª–∏ –∫–æ–º–∞–Ω–¥—ã:\n{command_text}")

    ,
        reply_markup=create_main_menu_keyboard()    #create_reply_keyboard()
    )

#–ê–∫—Ç—É–∞–ª—å–Ω—ã–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
def categories(update: Update, context: CallbackContext) -> None:

    if parent_id == None:
        cursor.execute("SELECT id,name FROM categories WHERE active AND parent_id = ?", (parent_id))

    row = cursor.fetchone()
    if row:
        zoo_id = row.zoo_id

        cursor.execute("SELECT * FROM animals WHERE zoo_id = ?", (zoo_id))
        result = cursor.fetchall()


#–†–∞–±–æ—Ç–∞ —Å –∫–∞—Ç–µ–≥–æ—Ä–∏–µ–π
def category(update: Update, context: CallbackContext) -> None:


#–î–æ–±–∞–≤–∏—Ç—å —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—é –≤ –∫–∞—Ç–µ–≥–æ—Ä–∏—é
def add(update: Update, context: CallbackContext) -> None:

#–ù–∞–π—Ç–∏ —Å–≤–æ—é —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—é
def find(update: Update, context: CallbackContext) -> None:

#–ò—Å–∫–∞—Ç—å —Å–ª—É—á–∞–π–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
def anything(update: Update, context: CallbackContext) -> None:

#–ò—Å–∫–∞—Ç—å —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ —Å–ª–æ–≤—É/—Ñ—Ä–∞–∑–µ
def specific(update: Update, context: CallbackContext) -> None:




def button_click(update: Update, context: CallbackContext) -> int:
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –Ω–∞–∂–∞—Ç–∏–π –∏–Ω–ª–∞–π–Ω-–∫–Ω–æ–ø–æ–∫"""
    query = update.callback_query  # –î–∞–Ω–Ω—ã–µ callback-–∑–∞–ø—Ä–æ—Å–∞
    query.answer()  # –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –ø–æ–ª—É—á–µ–Ω–∏—è callback

    # –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–Ω–æ–ø–∫–∏ –ê–∫—Ç—É–∞–ª—å–Ω—ã–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
    if query.data == 'categories':
        show_currency_categories(query)  # –í—ã–∑–æ–≤ —Ñ—É–Ω–∫—Ü–∏–∏ –ø–æ–∫–∞–∑–∞ –∫—É—Ä—Å–æ–≤
        return SHOW_INFO  # –ü–µ—Ä–µ—Ö–æ–¥ –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø–æ–∫–∞–∑–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏

    # –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–Ω–æ–ø–∫–∏ –ø–æ–≥–æ–¥—ã
    elif query.data == "weather":
        query.message.reply_text(
            "–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –≥–æ—Ä–æ–¥–∞:",
            reply_markup=ReplyKeyboardRemove()  # –£–¥–∞–ª–µ–Ω–∏–µ —Ç–µ–∫—É—â–µ–π –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã
        )
        return WAIT_CITY  # –ü–µ—Ä–µ—Ö–æ–¥ –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –æ–∂–∏–¥–∞–Ω–∏—è –≥–æ—Ä–æ–¥–∞

    # –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–Ω–æ–ø–∫–∏ –∫—É—Ä—Å–æ–≤ –≤–∞–ª—é—Ç
    elif query.data == 'currency':
        show_currency_rates(query)  # –í—ã–∑–æ–≤ —Ñ—É–Ω–∫—Ü–∏–∏ –ø–æ–∫–∞–∑–∞ –∫—É—Ä—Å–æ–≤
        return SHOW_INFO  # –ü–µ—Ä–µ—Ö–æ–¥ –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø–æ–∫–∞–∑–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏

    # –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–Ω–æ–ø–∫–∏ –≤–æ–∑–≤—Ä–∞—Ç–∞ –≤ –º–µ–Ω—é
    elif query.data == 'back_to_menu':
        query.edit_message_text(
            text="–ú–µ–Ω—é —Ä–∞–±–æ—Ç—ã —Å —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è–º–∏: ",
            reply_markup=create_main_menu_keyboard()  # –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –º–µ–Ω—é
        )
        return ConversationHandler.END  # –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ –¥–∏–∞–ª–æ–≥–∞

    # –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–Ω–æ–ø–∫–∏ –∑–∞–∫—Ä—ã—Ç–∏—è
    elif query.data == 'close':
        query.delete_message()  # –£–¥–∞–ª–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è —Å –º–µ–Ω—é
        return ConversationHandler.END  # –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ –¥–∏–∞–ª–æ–≥–∞

    return ConversationHandler.END  # –ó–∞–ø–∞—Å–Ω–æ–π –≤–∞—Ä–∏–∞–Ω—Ç –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è


def get_weather(update: Update, context: CallbackContext) -> int:
    """–ü–æ–ª—É—á–∞–µ—Ç –∏ –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç –ø–æ–≥–æ–¥—É –¥–ª—è —É–∫–∞–∑–∞–Ω–Ω–æ–≥–æ –≥–æ—Ä–æ–¥–∞"""
    city = update.message.text  # –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –≥–æ—Ä–æ–¥–∞ –∏–∑ —Å–æ–æ–±—â–µ–Ω–∏—è
    user = update.effective_user  # –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ
    user_id = user.id if user else 0  # ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (0 –µ—Å–ª–∏ –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω)
    username = user.username or user.first_name or "Unknown"  # –ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

    # –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ URL –¥–ª—è –∑–∞–ø—Ä–æ—Å–∞ –ø–æ–≥–æ–¥—ã
    url = f"https://api.openweathermap.org/data/2.5/weather?q={city}&appid={OPENWEATHER_API_KEY}&units=metric&lang=ru"

    try:
        response = requests.get(url)  # –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ HTTP-–∑–∞–ø—Ä–æ—Å–∞
        data = response.json()  # –ü–∞—Ä—Å–∏–Ω–≥ JSON-–æ—Ç–≤–µ—Ç–∞

        # –û–±—Ä–∞–±–æ—Ç–∫–∞ —É—Å–ø–µ—à–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞
        if response.status_code == 200:
            # –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞
            log_weather_request(user_id, username, city, 'success')

            # –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Ç—Ä–æ–∫–∏ —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ –ø–æ–≥–æ–¥–µ
            weather_info = (
                f"–ü–æ–≥–æ–¥–∞ –≤ {city}:\n"
                f"–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞: {data['main']['temp']} ¬∞C\n"
                f"–°–æ—Å—Ç–æ—è–Ω–∏–µ: {data['weather'][0]['description']}\n"
                f"–í–ª–∞–∂–Ω–æ—Å—Ç—å: {data['main']['humidity']} %\n"
                f"–í–µ—Ç–µ—Ä: {data['wind']['speed']} –º/—Å"
            )
            # –°–æ–∑–¥–∞–Ω–∏–µ –∫–Ω–æ–ø–∫–∏ –≤–æ–∑–≤—Ä–∞—Ç–∞
            keyboard = [[InlineKeyboardButton("üîô –ù–∞–∑–∞–¥ –≤ –º–µ–Ω—é", callback_data="back_to_menu")]]
            # –û—Ç–ø—Ä–∞–≤–∫–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø–æ–≥–æ–¥–µ
            update.message.reply_text(weather_info, reply_markup=InlineKeyboardMarkup(keyboard))
            return SHOW_INFO  # –ü–µ—Ä–µ—Ö–æ–¥ –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø–æ–∫–∞–∑–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏

        # –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–∫–∏ "–≥–æ—Ä–æ–¥ –Ω–µ –Ω–∞–π–¥–µ–Ω"
        log_weather_request(user_id, username, city, 'city_not_found')
        update.message.reply_text("–ì–æ—Ä–æ–¥ –Ω–µ –Ω–∞–π–¥–µ–Ω, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑:")
        return WAIT_CITY  # –ü–æ–≤—Ç–æ—Ä–Ω—ã–π –∑–∞–ø—Ä–æ—Å –≥–æ—Ä–æ–¥–∞

    except Exception as e:
        # –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–∏—Å—Ç–µ–º–Ω—ã—Ö –æ—à–∏–±–æ–∫
        log_weather_request(user_id, username, city, 'error')
        logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –ø–æ–≥–æ–¥—ã: {e}")
        update.message.reply_text("–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ")
        return ConversationHandler.END  # –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ –¥–∏–∞–ª–æ–≥–∞


def show_currency_categories(query):
    """–û—Ç–æ–±—Ä–∞–∂–∞–µ—Ç —Ç–µ–∫—É—â–∏–µ –∫—É—Ä—Å—ã –≤–∞–ª—é—Ç"""
    try:
        response = requests.get(CBR_API_URL)  # –ó–∞–ø—Ä–æ—Å –∫ API –¶–ë
        data = response.json()  # –ü–∞—Ä—Å–∏–Ω–≥ JSON-–æ—Ç–≤–µ—Ç–∞
        rates = data['Valute']  # –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –æ –≤–∞–ª—é—Ç–∞—Ö

        # –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞ —Å –∫—É—Ä—Å–∞–º–∏
        text = (
            f"–ö—É—Ä—Å—ã –¶–ë –†–§:\n"
            f"–î–æ–ª–ª–∞—Ä USA: {rates['USD']['Value']:.2f} ‚ÇΩ\n"
            f"–ï–≤—Ä–æ: {rates['EUR']['Value']:.2f} ‚ÇΩ\n"
            f"–Æ–∞–Ω—å: {rates['CNY']['Value']:.2f} ‚ÇΩ\n"
        )
        # –ö–Ω–æ–ø–∫–∞ –≤–æ–∑–≤—Ä–∞—Ç–∞ –≤ –º–µ–Ω—é
        keyboard = [[InlineKeyboardButton("üîô –ù–∞–∑–∞–¥ –≤ –º–µ–Ω—é", callback_data="back_to_menu")]]
        # –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è —Å –∫—É—Ä—Å–∞–º–∏
        query.edit_message_text(
            text=text, reply_markup=InlineKeyboardMarkup(keyboard)
        )
    except Exception as e:
        # –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –ø–æ–ª—É—á–µ–Ω–∏—è –∫—É—Ä—Å–æ–≤
        logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –∫—É—Ä—Å–∞ –≤–∞–ª—é—Ç: {e}")
        query.edit_message_text("–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –∫—É—Ä—Å—ã –≤–∞–ª—é—Ç")


def cancel(update: Update, context: CallbackContext) -> int:
    """–û—Ç–º–µ–Ω–∞ —Ç–µ–∫—É—â–µ–≥–æ –¥–µ–π—Å—Ç–≤–∏—è"""
    update.message.reply_text("–î–µ–π—Å—Ç–≤–∏–µ –æ—Ç–º–µ–Ω–µ–Ω–æ", reply_markup=create_reply_keyboard())
    return ConversationHandler.END  # –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ –¥–∏–∞–ª–æ–≥–∞


def comments_stats(update: Update, context: CallbackContext):
    """–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∑–∞–ø—Ä–æ—Å–æ–≤ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π (—Ç–æ–ª—å–∫–æ –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤)"""
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
    # print(f" {update.effective_user.id}  -  {ADMIN_IDS}")
    # if f"{update.effective_user.id}" not in ADMIN_IDS:
    #     update.message.reply_text("‚ö†Ô∏è –≠—Ç–∞ –∫–æ–º–∞–Ω–¥–∞ –¥–æ—Å—Ç—É–ø–Ω–∞ —Ç–æ–ª—å–∫–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞–º")
    #     return

    try:
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è –∏ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ —Ñ–∞–π–ª–∞ –ª–æ–≥–æ–≤
        if not os.path.exists(COMMENT_LOG_PATH) or os.path.getsize(COMMENT_LOG_PATH) == 0:
            update.message.reply_text("üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ–∫–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞. –ó–∞–ø—Ä–æ—Å—ã –µ—â–µ –Ω–µ –¥–µ–ª–∞–ª–∏—Å—å.")
            return

        # –ß—Ç–µ–Ω–∏–µ –∏ –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–∞–π–ª–∞ –ª–æ–≥–æ–≤
        logs = []
        with open(COMMENT_LOG_PATH, 'r', encoding='utf-8') as f:
            reader = csv.reader(f)
            next(reader, None)  # –ü—Ä–æ–ø—É—Å–∫ –∑–∞–≥–æ–ª–æ–≤–∫–∞

            for row in reader:
                if not row:  # –ü—Ä–æ–ø—É—Å–∫ –ø—É—Å—Ç—ã—Ö —Å—Ç—Ä–æ–∫
                    continue
                # –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è —Å—Ç—Ä–æ–∫ (–¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–µ–¥–æ—Å—Ç–∞—é—â–∏—Ö –∑–Ω–∞—á–µ–Ω–∏–π)
                if len(row) < 6:
                    row += [''] * (6 - len(row))
                logs.append(row[:6])  # –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ç–æ–ª—å–∫–æ –ø–µ—Ä–≤—ã—Ö 5 –∑–Ω–∞—á–µ–Ω–∏–π

        # –°–æ–∑–¥–∞–Ω–∏–µ DataFrame –∏–∑ –ª–æ–≥–æ–≤
        df = pd.DataFrame(logs, columns=['timestamp', 'user_id', 'username', 'category_id', 'keyword', 'status'])

        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –Ω–∞–ª–∏—á–∏–µ –¥–∞–Ω–Ω—ã—Ö
        if df.empty:
            update.message.reply_text("üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ–∫–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞. –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞.")
            return

        # –ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ user_id –∏ category_id –≤ —á–∏—Å–ª–æ–≤–æ–π —Ñ–æ—Ä–º–∞—Ç
        df['user_id'] = pd.to_numeric(df['user_id'], errors='coerce')
        df['category_id'] = pd.to_numeric(df['category_id'], errors='coerce')

        # –†–∞—Å—á–µ—Ç –æ—Å–Ω–æ–≤–Ω—ã—Ö –º–µ—Ç—Ä–∏–∫
        total_requests = len(df)  # –û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø—Ä–æ—Å–æ–≤
        status_counts = df['status'].value_counts()  # –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ —Å—Ç–∞—Ç—É—Å–∞–º
        success_requests = status_counts.get('success', 0)  # –£—Å–ø–µ—à–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã
        error_requests = status_counts.get('error', 0)  # –û—à–∏–±–∫–∏ —Å–µ—Ä–≤–µ—Ä–∞
        unique_users = df['user_id'].nunique()  # –£–Ω–∏–∫–∞–ª—å–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏
        unique_categories = df[df['status'] == 'success'].nunique()  # –£–Ω–∏–∫–∞–ª—å–Ω—ã–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ (—Ç–æ–ª—å–∫–æ —É—Å–ø–µ—à–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã)

        # –¢–æ–ø-5 —Å–ª–æ–≤/—Ñ—Ä–∞–∑ (—Ç–æ–ª—å–∫–æ —É—Å–ø–µ—à–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã)
        popular_keywords = df[df['status'] == 'success']['keyword'].value_counts().head(5)

        # –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ –æ—Ç—á–µ—Ç–∞
        report = (
            f"üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∑–∞–ø—Ä–æ—Å–æ–≤ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π:\n"
            f"‚Ä¢ –í—Å–µ–≥–æ –∑–∞–ø—Ä–æ—Å–æ–≤: {total_requests}\n"
            f"‚Ä¢ –£—Å–ø–µ—à–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤: {success_requests}\n"
            f"‚Ä¢ –ù–µ—É—Å–ø–µ—à–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤: {error_requests}\n"
            f"‚Ä¢ –£–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: {unique_users}\n\n"
            f"‚Ä¢ –£–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –∫–∞—Ç–µ–≥–æ—Ä–∏–π: {unique_categories}\n\n"
            f"üèôÔ∏è –¢–æ–ø-5 –ø–æ–∏—Å–∫–æ–≤—ã—Ö —Å–ª–æ–≤/—Ñ—Ä–∞–∑:\n"
        )

        # –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø–æ–∏—Å–∫–æ–≤—ã—Ö —Å–ª–æ–≤–∞—Ö/—Ñ—Ä–∞–∑–∞—Ö
        if not popular_keywords.empty:
            for keyword, count in popular_keywords.items():
                report += f"  - {keyword}: {count}\n"
        else:
            report += "  –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ –ø–æ–∏—Å–∫–æ–≤—ã—Ö —Å–ª–æ–≤–∞—Ö/—Ñ—Ä–∞–∑–∞—Ö\n"

        # –ê–Ω–∞–ª–∏–∑ –µ–∂–µ–¥–Ω–µ–≤–Ω–æ–π –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –ø–æ–∏—Å–∫–∞ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π
        try:
            # –ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ –∏ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è
            df['timestamp'] = pd.to_datetime(df['timestamp'], errors='coerce')
            df = df.dropna(subset=['timestamp'])

            if not df.empty:
                # –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –ø–æ –¥–∞—Ç–µ
                df['date'] = df['timestamp'].dt.date
                daily_activity = df.groupby('date').size().reset_index(name='requests')
                # –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –∏ –≤—ã–±–æ—Ä –ø–æ—Å–ª–µ–¥–Ω–∏—Ö 7 –¥–Ω–µ–π
                daily_activity = daily_activity.sort_values('date', ascending=False).head(7)

                # –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –≤ –æ—Ç—á–µ—Ç
                if not daily_activity.empty:
                    report += "\nüìÖ –ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –ø–æ–∏—Å–∫–∞ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 7 –¥–Ω–µ–π:\n"
                    for _, row in daily_activity.iterrows():
                        report += f"  {row['date']}: {row['requests']} –∑–∞–ø—Ä–æ—Å–æ–≤\n"
                else:
                    report += "\nüìÖ –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ –µ–∂–µ–¥–Ω–µ–≤–Ω–æ–π –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –ø–æ–∏—Å–∫–∞ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π\n"
            else:
                report += "\nüìÖ –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ –µ–∂–µ–¥–Ω–µ–≤–Ω–æ–π –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –ø–æ–∏—Å–∫–∞ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π\n"
        except Exception as e:
            # –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –∞–Ω–∞–ª–∏–∑–∞ –≤—Ä–µ–º–µ–Ω–∏
            logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–∞—Å—á–µ—Ç–µ –µ–∂–µ–¥–Ω–µ–≤–Ω–æ–π –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –ø–æ–∏—Å–∫–∞ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π: {e}")
            report += "\nüìÖ –ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å—Å—á–∏—Ç–∞—Ç—å –µ–∂–µ–¥–Ω–µ–≤–Ω—É—é –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –ø–æ–∏—Å–∫–∞ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π\n"

        # –û—Ç–ø—Ä–∞–≤–∫–∞ —Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ –æ—Ç—á–µ—Ç–∞
        update.message.reply_text(report)

        # –°–æ–∑–¥–∞–Ω–∏–µ –∏ –æ—Ç–ø—Ä–∞–≤–∫–∞ –≥—Ä–∞—Ñ–∏–∫–∞ (–µ—Å–ª–∏ –µ—Å—Ç—å –¥–∞–Ω–Ω—ã–µ)
        if not popular_keywords.empty:
            plt.figure(figsize=(10, 6))  # –†–∞–∑–º–µ—Ä –≥—Ä–∞—Ñ–∏–∫–∞
            # –ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ —Å—Ç–æ–ª–±—á–∞—Ç–æ–π –¥–∏–∞–≥—Ä–∞–º–º—ã
            popular_keywords.plot(kind='bar', color='skyblue')
            plt.title('–¢–æ–ø –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ–º—ã—Ö —Å–ª–æ–≤/—Ñ—Ä–∞–∑')  # –ó–∞–≥–æ–ª–æ–≤–æ–∫
            plt.ylabel('–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø—Ä–æ—Å–æ–≤')  # –ü–æ–¥–ø–∏—Å—å –æ—Å–∏ Y
            plt.xticks(rotation=45, ha='right')  # –ù–∞–∫–ª–æ–Ω –ø–æ–¥–ø–∏—Å–µ–π
            plt.tight_layout()  # –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è —Ä–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏—è

            # –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –±–∏–Ω–∞—Ä–Ω—ã–π –±—É—Ñ–µ—Ä
            buf = BytesIO()
            plt.savefig(buf, format='png', dpi=80)
            buf.seek(0)

            # –û—Ç–ø—Ä–∞–≤–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
            update.message.reply_photo(photo=buf)
            buf.close()  # –ó–∞–∫—Ä—ã—Ç–∏–µ –±—É—Ñ–µ—Ä–∞
            plt.close()  # –ó–∞–∫—Ä—ã—Ç–∏–µ –≥—Ä–∞—Ñ–∏–∫–∞

    except Exception as e:
        # –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ–±—â–∏—Ö –æ—à–∏–±–æ–∫ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
        logger.error(f"–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏: {e}", exc_info=True)
        update.message.reply_text("‚ö†Ô∏è –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏")


def main():
    """–û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –∏ –∑–∞–ø—É—Å–∫–∞ –±–æ—Ç–∞"""
    # TOKEN = os.getenv("TELEGRAM_BOT_TOKEN")
    # OPENWEATHER_API_KEY = os.getenv("OPENWEATHER_API_KEY")  # API-–∫–ª—é—á OpenWeatherMap
    # my_telegram_id = os.getenv("MY_TELEGRAM_ID")
    #
    # print(f"—Ç–æ–∫–µ–Ω={TOKEN} OPENWEATHER_API_KEY = {OPENWEATHER_API_KEY} my_telegram_id ={my_telegram_id}")
    updater = Updater(TOKEN)  # –°–æ–∑–¥–∞–Ω–∏–µ –æ–±—ä–µ–∫—Ç–∞ Updater
    dispatcher = updater.dispatcher  # –ü–æ–ª—É—á–µ–Ω–∏–µ –¥–∏—Å–ø–µ—Ç—á–µ—Ä–∞

    # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞ –¥–∏–∞–ª–æ–≥–æ–≤ –¥–ª—è –ø–æ–≥–æ–¥—ã
    conv_handler = ConversationHandler(
        entry_points=[CallbackQueryHandler(button_click, pattern='^weather$')],  # –¢–æ—á–∫–∞ –≤—Ö–æ–¥–∞
        states={
            WAIT_CITY: [MessageHandler(Filters.text & ~Filters.command, get_weather)],  # –û–∂–∏–¥–∞–Ω–∏–µ –≥–æ—Ä–æ–¥–∞
            SHOW_INFO: [CallbackQueryHandler(button_click)]  # –ü–æ–∫–∞–∑–∞—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
        },
        fallbacks=[CommandHandler('cancel', cancel)],  # –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—Ç–º–µ–Ω—ã
        allow_reentry=True  # –†–∞–∑—Ä–µ—à–µ–Ω–∏–µ –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ –≤—Ö–æ–¥–∞
    )

    # –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤
    dispatcher.add_handler(conv_handler)  # –î–∏–∞–ª–æ–≥–∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π
    dispatcher.add_handler(CommandHandler("start", start))  # –ö–æ–º–∞–Ω–¥–∞ /start
    dispatcher.add_handler(CommandHandler("categories", categories))  # –ö–æ–º–∞–Ω–¥–∞ /categories
    dispatcher.add_handler(CommandHandler("category", category))  # –ö–æ–º–∞–Ω–¥–∞ /category
    dispatcher.add_handler(CommandHandler("add", add))  # –ö–æ–º–∞–Ω–¥–∞ /add
    dispatcher.add_handler(CommandHandler("find", find)) # –ö–æ–º–∞–Ω–¥–∞ /find
    dispatcher.add_handler(CommandHandler("anything", anything))  # –ö–æ–º–∞–Ω–¥–∞ /anything
    dispatcher.add_handler(CommandHandler("specific", specific))  # –ö–æ–º–∞–Ω–¥–∞ /specific

    # –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∏–Ω–ª–∞–π–Ω-–∫–Ω–æ–ø–æ–∫
    dispatcher.add_handler(CallbackQueryHandler(button_click, pattern='^(currency|back_to_menu|close)$'))
    # –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
    dispatcher.add_handler(CommandHandler("comments_stats", comments_stats))

    updater.start_polling()  # –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞ –≤ —Ä–µ–∂–∏–º–µ –æ–ø—Ä–æ—Å–∞
    logger.info("–ë–æ—Ç –∑–∞–ø—É—â–µ–Ω –∏ –≥–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ")  # –ó–∞–ø–∏—Å—å –≤ –ª–æ–≥
    updater.idle()  # –ë–µ—Å–∫–æ–Ω–µ—á–Ω—ã–π —Ü–∏–∫–ª –¥–æ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏


if __name__ == '__main__':
    main()  # –ó–∞–ø—É—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è